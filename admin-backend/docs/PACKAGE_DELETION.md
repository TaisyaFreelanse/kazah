# Удаление пакетов

## Обзор

Пакеты можно удалять из админ-панели. При удалении пакет полностью удаляется из базы данных и все связанные файлы также удаляются.

## Процесс удаления

### В админ-панели

1. Откройте раздел "Пакетные вопросы"
2. Найдите пакет, который хотите удалить
3. Нажмите кнопку "Удалить пакет"
4. Подтвердите удаление в диалоговом окне
5. Пакет будет удален из базы данных и исчезнет из списка

### Что происходит при удалении

1. **Удаление файлов**: Все файлы пакета (KZ и RU) удаляются с сервера
2. **Удаление из базы данных**: 
   - Пакет удаляется из таблицы `packages`
   - Файлы пакета автоматически удаляются из таблицы `package_files` (ON DELETE CASCADE)
3. **Обновление UI**: Пакет исчезает из списка в админ-панели
4. **Публичный API**: Удаленный пакет больше не возвращается через `/api/public/packages`

## API Endpoint

### DELETE /api/packages/:id

**Требует авторизации**: Да (JWT токен)

**Параметры**:
- `id` (URL параметр) - ID пакета для удаления

**Ответ при успехе**:
```json
{
  "message": "Пакет успешно удален"
}
```

**Ошибки**:
- `404` - Пакет не найден
- `401` - Не авторизован
- `500` - Ошибка сервера

## Важные замечания

### ⚠️ Внимание: Удаление необратимо

- После удаления пакет **полностью исчезает** из базы данных
- **Нельзя восстановить** удаленный пакет
- Все файлы пакета **удаляются с сервера**
- Пользователи, которые купили пакет, **потеряют доступ** к вопросам из этого пакета

### Рекомендации

1. **Перед удалением**:
   - Убедитесь, что пакет действительно нужно удалить
   - Рассмотрите возможность **деактивации** вместо удаления (через тумблер "Активен/Неактивен")
   - Деактивация позволяет скрыть пакет от новых пользователей, но сохранить доступ для тех, кто уже купил

2. **Альтернатива удалению**:
   - Используйте тумблер "Активен/Неактивен" для временного скрытия пакета
   - Это позволяет сохранить пакет в базе данных и восстановить его позже

## Влияние на приложение

### Android приложение

После удаления пакета:
- ❌ Пакет **не отображается** в списке доступных пакетов
- ❌ Пользователи **не могут купить** удаленный пакет
- ❌ Пользователи, которые купили пакет, **теряют доступ** к вопросам из этого пакета
- ✅ Приложение продолжает работать с другими пакетами

### Публичный API

- Удаленный пакет **не возвращается** через `GET /api/public/packages`
- Запрос `GET /api/public/packages/:id` для удаленного пакета вернет `404`

## Пример использования

### Удаление через админ-панель

1. Войдите в админ-панель
2. Перейдите в раздел "Пакетные вопросы"
3. Найдите пакет "История Казахстана"
4. Нажмите "Удалить пакет"
5. Подтвердите удаление
6. Пакет исчезнет из списка

### Удаление через API (для разработчиков)

```bash
# Получить токен авторизации
TOKEN="your_jwt_token"

# Удалить пакет с ID 1
curl -X DELETE \
  https://blim-bilem-admin-backend.onrender.com/api/packages/1 \
  -H "Authorization: Bearer $TOKEN"
```

## Логика удаления в коде

### Backend (routes/packages.js)

```javascript
router.delete('/:id', authenticateToken, async (req, res) => {
  // 1. Найти пакет
  const packageItem = await Package.findById(req.params.id);
  
  // 2. Удалить файлы с сервера
  if (packageItem.files.kz?.file_url) {
    await fs.unlink(path.join(__dirname, '..', packageItem.files.kz.file_url));
  }
  if (packageItem.files.ru?.file_url) {
    await fs.unlink(path.join(__dirname, '..', packageItem.files.ru.file_url));
  }
  
  // 3. Удалить пакет из базы данных
  // Файлы удалятся автоматически из-за ON DELETE CASCADE
  await Package.delete(req.params.id);
});
```

### Frontend (Packages.jsx)

```javascript
const handleDeletePackage = async (packageId) => {
  // 1. Подтверждение
  if (!window.confirm('Вы уверены, что хотите удалить этот пакет?')) {
    return;
  }
  
  // 2. Удаление через API
  await axios.delete(`/api/packages/${packageId}`);
  
  // 3. Обновление списка
  setPackages(packages.filter(pkg => pkg.id !== packageId));
};
```

## База данных

### Схема удаления

```sql
-- При удалении пакета файлы удаляются автоматически
CREATE TABLE package_files (
  package_id INTEGER REFERENCES packages(id) ON DELETE CASCADE,
  -- ...
);
```

Благодаря `ON DELETE CASCADE`, при удалении пакета все связанные записи в `package_files` удаляются автоматически.

