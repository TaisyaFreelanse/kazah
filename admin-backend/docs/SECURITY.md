# Безопасность админ-панели

## Обзор

Админ-панель "Blim Bilem" реализует многоуровневую систему безопасности для защиты от несанкционированного доступа и обеспечения целостности данных.

## Аутентификация и авторизация

### JWT (JSON Web Tokens)

Система использует JWT токены для аутентификации пользователей:

- **Алгоритм**: HS256
- **Секретный ключ**: хранится в переменной окружения `JWT_SECRET`
- **Срок действия**: 24 часа (можно настроить)
- **Хранение**: токен хранится в `localStorage` на клиенте

### Middleware защиты

Все административные endpoints защищены middleware `authenticateToken`:

```javascript
export const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'Токен доступа не предоставлен' });
  }

  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({ error: 'Недействительный токен' });
    }
    req.user = user;
    next();
  });
};
```

### Защищенные маршруты

**Backend (требуют авторизации):**
- `GET /api/packages` - Получить все пакеты
- `POST /api/packages` - Создать пакет
- `PUT /api/packages/:id` - Обновить пакет
- `DELETE /api/packages/:id` - Удалить пакет
- `POST /api/packages/:id/upload` - Загрузить файл
- `DELETE /api/packages/:id/file/:language` - Удалить файл
- `POST /api/public-questions/upload` - Загрузить вопросы
- `POST /api/phrases/upload` - Загрузить фразы
- `POST /api/auth/change-password` - Сменить пароль

**Frontend (требуют авторизации):**
- `/` - Dashboard
- `/public-questions` - Управление вопросами
- `/packages` - Управление пакетами
- `/packages/:id` - Детали пакета
- `/phrases` - Управление фразами
- `/change-password` - Смена пароля

### Публичные маршруты

**Backend (не требуют авторизации):**
- `GET /api/public/packages` - Получить активные пакеты (для приложения)
- `GET /api/public/packages/:id` - Получить активный пакет (для приложения)
- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/init` - Инициализация первого администратора

## Защита от несанкционированного доступа

### Frontend защита

#### ProtectedRoute компонент

Все административные страницы обернуты в `ProtectedRoute`, который:
- Проверяет наличие токена
- Перенаправляет на страницу входа, если не авторизован
- Показывает индикатор загрузки при проверке токена

```jsx
const ProtectedRoute = ({ children }) => {
  const { isAuthenticated, loading } = useAuth();

  if (loading) {
    return <LoadingScreen />;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return children;
};
```

#### AuthContext

`AuthContext` управляет состоянием аутентификации:
- Проверяет токен при загрузке приложения
- Автоматически добавляет токен в заголовки запросов
- Очищает токен при выходе

### Backend защита

#### Валидация токена на сервере

Каждый защищенный endpoint проверяет токен:
1. Извлекает токен из заголовка `Authorization`
2. Проверяет подпись токена
3. Проверяет срок действия
4. Добавляет данные пользователя в `req.user`

#### Обработка ошибок авторизации

- **401 Unauthorized** - токен не предоставлен или недействителен
- **403 Forbidden** - токен недействителен или истек
- **404 Not Found** - ресурс не найден

## Смена пароля

### Реализация

Администратор может изменить свой пароль через:
- Страницу `/change-password` в админ-панели
- API endpoint `POST /api/auth/change-password`

### Требования к паролю

- Минимум 6 символов (рекомендуется 8+)
- Новый пароль должен отличаться от текущего
- Проверка текущего пароля перед изменением

### Процесс смены пароля

1. Пользователь вводит текущий пароль
2. Пользователь вводит новый пароль и подтверждение
3. Валидация на клиенте (длина, совпадение)
4. Отправка запроса на сервер
5. Проверка текущего пароля на сервере
6. Хеширование нового пароля (bcrypt)
7. Обновление пароля в базе данных

### Безопасность паролей

- **Хеширование**: bcrypt с 10 раундами
- **Соль**: автоматически генерируется bcrypt
- **Хранение**: только хешированные пароли в базе данных
- **Передача**: пароли передаются только через HTTPS

## Валидация прав доступа на сервере

### Проверка на каждом запросе

Все административные операции проверяют:
1. Наличие токена
2. Валидность токена
3. Права доступа (все админы имеют полные права)

### Примеры валидации

#### Создание пакета

```javascript
router.post('/', authenticateToken, async (req, res) => {
  // req.user содержит данные из токена
  // Только авторизованные пользователи могут создать пакет
  // ...
});
```

#### Удаление пакета

```javascript
router.delete('/:id', authenticateToken, async (req, res) => {
  // Проверка авторизации через middleware
  // Проверка существования пакета
  // Удаление пакета
  // ...
});
```

#### Загрузка файла

```javascript
router.post('/:id/upload', authenticateToken, upload.single('file'), async (req, res) => {
  // Проверка авторизации
  // Валидация файла
  // Сохранение файла
  // ...
});
```

## Дополнительные меры безопасности

### Валидация входных данных

- Проверка типов данных
- Валидация форматов (email, файлы)
- Ограничение размера файлов (10MB)
- Проверка MIME типов файлов

### Защита от SQL инъекций

- Использование параметризованных запросов
- Все запросы используют `$1, $2, ...` параметры
- Никаких строковых конкатенаций SQL

### Защита от XSS

- Экранирование пользовательского ввода
- React автоматически экранирует данные
- Валидация на сервере

### CORS настройки

```javascript
app.use(cors());
```

Для production рекомендуется настроить CORS более строго:

```javascript
app.use(cors({
  origin: process.env.FRONTEND_URL,
  credentials: true
}));
```

### Переменные окружения

Все чувствительные данные хранятся в переменных окружения:
- `JWT_SECRET` - секретный ключ для JWT
- `DATABASE_URL` - строка подключения к БД
- `ADMIN_DEFAULT_PASSWORD` - пароль по умолчанию

## Рекомендации по безопасности

### Для администраторов

1. **Используйте сильные пароли**:
   - Минимум 8 символов
   - Буквы, цифры, специальные символы
   - Не используйте простые пароли

2. **Регулярно меняйте пароль**:
   - Меняйте пароль каждые 3-6 месяцев
   - Используйте уникальный пароль

3. **Не передавайте пароль**:
   - Не сообщайте пароль третьим лицам
   - Не сохраняйте пароль в открытом виде

4. **Используйте HTTPS**:
   - Всегда используйте HTTPS в production
   - Не передавайте данные через HTTP

### Для разработчиков

1. **Храните секреты безопасно**:
   - Используйте переменные окружения
   - Не коммитьте секреты в Git
   - Используйте `.env` файлы (в .gitignore)

2. **Регулярно обновляйте зависимости**:
   - Проверяйте уязвимости
   - Обновляйте пакеты

3. **Логируйте подозрительную активность**:
   - Неудачные попытки входа
   - Ошибки авторизации
   - Подозрительные запросы

4. **Используйте rate limiting**:
   - Ограничьте количество запросов
   - Защита от brute force атак

## Мониторинг безопасности

### Логирование

Система логирует:
- Неудачные попытки входа
- Ошибки авторизации
- Ошибки валидации
- Ошибки загрузки файлов

### Health Check

Endpoint `/api/health` позволяет проверить статус API без авторизации.

## Обновление безопасности

### Планируемые улучшения

1. **Rate Limiting** - ограничение количества запросов
2. **2FA** - двухфакторная аутентификация
3. **Session Management** - управление сессиями
4. **Audit Log** - журнал действий администраторов
5. **IP Whitelist** - белый список IP адресов

## Контакты

При обнаружении уязвимостей безопасности, пожалуйста, сообщите об этом немедленно.

